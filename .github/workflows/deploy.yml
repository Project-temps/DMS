name: Deploy to Windows VPS

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        python manage.py test
    
    - name: Deploy to Windows VPS
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Deploy using SSH
      run: |
        ssh -vvv -o StrictHostKeyChecking=no ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} '
          cd C:\Users\a_shi\source\2025repo\DMS
          git pull origin main
          C:\REPO\dms2\DMS\venv\Scripts\python.exe -m pip install --upgrade pip
          C:\REPO\dms2\DMS\venv\Scripts\pip.exe install -r requirements.txt
          C:\REPO\dms2\DMS\venv\Scripts\python.exe manage.py migrate
          C:\REPO\dms2\DMS\venv\Scripts\python.exe manage.py collectstatic --noinput
          net stop dms2
          net start dms2
        '
